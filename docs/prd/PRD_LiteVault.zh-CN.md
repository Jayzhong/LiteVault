# LiteVault 产品需求文档 (PRD)

**版本**: 1.0 (V1 Current)
**日期**: 2025-12-30
**状态**: 已上线 / 迭代中
**语言**: zh-CN

---

## 1. 概述 (Overview)

### 1.1 问题陈述
在信息过载的时代，知识工作者难以高效地捕捉转瞬即逝的灵感并进行有效整理。传统的笔记应用要么过于简单（缺乏整理结构），要么过于复杂（需要预先设计分类体系）。用户需要一个“第二大脑”，既能实现无摩擦的快速记录，又能支持后续的智能整理。

### 1.2 产品愿景
**LiteVault** 是一款专为“先记录，后整理”工作流设计的个人知识管理工具。它利用 AI 承担总结和打标签等繁重工作，但严格保留用户的控制权。
*   **极简记录 (Lightweight Capture)**：将记录的摩擦力降至零。
*   **AI 智能增强 (AI-Assisted Enrichment)**：自动生成标题、摘要和推荐标签。
*   **人机协同 (Human-in-the-Loop)**：AI 仅提供建议草稿，最终决定权在用户手中。
*   **信任 (Trust)**：数据属于用户。AI 是工具，而非主人。

### 1.3 目标用户
*   **知识工作者**：研究人员、作家、开发者等需要处理和产出大量信息的人群。
*   **终身学习者**：希望留存阅读内容和思考点滴的用户。

---

## 2. 当前 V1 版本 (Current V1 Implementation)

本节描述目前 `main` 分支中已实现的功能。

### 2.1 信息架构
应用分为四个主要视图（桌面端通过侧边栏访问，移动端通过抽屉访问）：
1.  **首页 (Home)**：记录界面和“待确认”队列。
2.  **搜索 (Search)**：专用的搜索界面。
3.  **知识库 (Library)**：所有已确认为“归档”条目的时间轴视图。
4.  **设置 (Settings)**：账户资料、偏好设置和标签管理。

### 2.2 核心流程与功能

#### 2.2.1 身份认证 (Authentication)
*   **服务提供商**：使用 **Clerk** 处理所有身份管理（注册、登录、个人资料、会话）。
*   **后端同步**：用户首次发起 API 请求时，后端通过 `clerk_user_id` 自动映射到本地 `users` 表。
*   **安全访问**：所有数据接口均受 JWT 验证保护。

#### 2.2.2 记录与增强 (Capture & Enrichment)
*   **输入方式**：首页简单的文本输入框。支持键入 `#` 触发标签选择器。
*   **模式**：
    *   **AI 增强模式（默认）**：条目进入 `ENRICHING`（处理中）状态。异步后台任务会生成 **标题**、**摘要** 和 **推荐标签**。
    *   **手动保存模式**：用户关闭 AI 开关。条目直接保存为 `ARCHIVED`（已归档）状态，仅包含原始内容和手动选择的标签。
*   **状态流转**：`DRAFT` (客户端) -> `SAVING` -> `ENRICHING` (服务端) -> `READY_TO_CONFIRM`。

#### 2.2.3 待确认审核 (Pending Review)
*   **队列**：处于 `READY_TO_CONFIRM` 状态的条目会显示在首页的“待确认”区域。
*   **审核弹窗**：
    *   展示 AI 生成的摘要。
    *   **标签审核**：用户接受或拒绝 AI 推荐的标签。
    *   **手动补充**：用户可从现有标签库中添加标签。
*   **操作**：
    *   **确认并保存 (Confirm & Save)**：条目变为 `ARCHIVED` 状态。标签被持久化到全局标签库。
    *   **丢弃 (Discard)**：条目变为 `DISCARDED`（软删除）。

#### 2.2.4 知识库与检索 (Library & Retrieval)
*   **时间轴**：已归档条目按时间倒序排列（`confirmed_at`）。
*   **搜索 V1 (词法搜索)**：
    *   **标签模式**：以 `#` 开头的查询仅搜索匹配该标签的条目。
    *   **混合模式**：普通文本查询会同时匹配标题、摘要、原始内容或标签（基于 `pg_trgm` 模糊匹配）。
*   **分页**：基于游标 `(confirmed_at, id)` 的无限滚动，保证数据稳定性。

#### 2.2.5 标签管理 (Tag Management)
*   **全局注册表**：标签是用户隔离的独立实体。
*   **属性**：名称（保留大小写）、颜色（Hex 代码）、使用次数。
*   **管理操作**：
    *   **创建**：在记录时隐式创建，或在设置中显式创建。采用 Upsert 逻辑（支持恢复软删除的标签）。
    *   **更新**：重命名或更改颜色。
    *   **删除**：软删除（从 UI 中隐藏，保留历史数据关联）。

### 2.3 系统与非功能性需求
*   **可靠性**：异步增强采用“发件箱模式 (Outbox Pattern)”，确保即使 Worker 崩溃任务也不会丢失。
*   **成本护栏**：
    *   **配额**：每日 AI 增强次数限制（免费版：50，专业版：500）。
    *   **并发**：限制单用户并发任务数，防止滥用。
*   **低延迟**：记录接口立即返回 `201 Created` (<200ms)，将 AI 处理放在后台进行。

---

## 3. UX 体验要求

### 3.1 界面状态
*   **加载中**：卡片列表和详情页必须使用骨架屏 (Skeleton)，避免使用阻塞式的加载转圈。
*   **空状态**：所有列表（知识库、待确认、搜索、标签）必须有描述清晰的空状态和行动号召（例如：“记录你的第一个想法...”）。
*   **错误处理**：瞬时错误（网络）触发带有“重试”选项的 Toast 通知；持久错误（AI 失败）允许手动重试或丢弃。

### 3.2 文案与本地化
*   **策略**：所有 UI 字符串集中在 `microcopy.ts` 管理（与 `docs/design/MICROCOPY.md` 同步）。严禁在组件中硬编码字符串。
*   **语调**：冷静、极简、支持性。

### 3.3 移动端适配
*   **导航**：移动端使用可折叠的“抽屉 (Sheet)”菜单，桌面端使用固定侧边栏。
*   **布局**：
    *   **首页**：两栏布局的输入框在移动端自动堆叠为垂直布局。
    *   **表格**：标签管理表格在移动端自动转换为卡片视图。

---

## 4. 隐私与信任

### 4.1 数据存储
*   所有用户内容（笔记、摘要、标签）存储在私有 PostgreSQL 数据库中。
*   数据在存储库层级严格按 `user_id` 隔离。

### 4.2 AI 使用披露
*   **透明度**：明确告知用户文本将被发送给 LLM（LiteLLM 提供商）进行增强处理。
*   **选择权**：用户可以在设置中全局关闭，或在记录时单次关闭“AI 建议”。
*   **数据留存**：我们不使用用户数据训练公共模型。

### 4.3 人类控制
*   **拒绝静默写入**：AI 绝不会直接写入用户的永久知识库。所有 AI 输出必须经过“待确认”暂存区（除非用户在未来版本中显式更改此设置）。

---

## 5. 成功指标

### 5.1 激活 (Activation)
*   **注册**：完成邮箱/账户创建。
*   **顿悟时刻 (Aha! Moment)**：首次“确认”操作（将条目从待确认区移动到知识库）。

### 5.2 参与度 (Engagement)
*   **记录量**：每周创建的条目数量。
*   **审核率**：待确认条目中被确认 vs 被丢弃的比例。
*   **检索**：每周搜索或浏览知识库的次数。

---

## 6. 限制与约束

*   **无语义搜索**：V1 依赖关键词匹配。不同词同义（如“汽车”与“轿车”）无法关联。
*   **无原生 App**：目前仅支持 Web 端（PWA 就绪）。
*   **单租户**：不支持团队或共享知识库。

---

## 7. 路线图与迭代 (Roadmap)

### 7.1 近期：V1.1 / V1.2
*   **重点**：稳定性、细节打磨、移动端优化。
*   **功能补全**：
    *   **移动端打磨**：优化触摸目标，增加“滑动丢弃”等手势支持。
    *   **标签分析**：在设置中可视化展示标签使用情况。
    *   **导出**：简单的 JSON/Markdown 导出，确保用户数据可迁移。

### 7.2 中期：V2
*   **主题 A：自动化整理 (聚类)**
    *   *价值*：减少标签混乱。
    *   *范围*：后台 AI 任务扫描知识库，建议合并相似标签（如 "dev" 和 "development"）。
*   **主题 D：语义检索**
    *   *价值*：通过概念而非仅仅关键词查找想法。
    *   *范围*：引入向量数据库 (pgvector)。在确认时对条目进行 Embedding 嵌入。“向你的知识库提问”自然语言接口。
*   **主题 E：个性化**
    *   *价值*：让 AI 更懂用户的语气。
    *   *范围*：可配置 AI 的语气风格/摘要长度设置。

### 7.3 长期愿景：V3
*   **主题 B：知识图谱**
    *   *价值*：发现隐藏的连接。
    *   *范围*：自动链接相关笔记（“此笔记与 X 相关，因为...”）。可视化图谱。
*   **主题 C：回顾与记忆**
    *   *价值*：主动学习，对抗遗忘。
    *   *范围*：间隔重复系统 (SRS) 用于复习旧笔记。“那年今日”回顾功能。
*   **主题 G：安全与健康**
    *   *价值*：防止知识库腐烂。
    *   *范围*：自动识别“过时”或“相互冲突”的信息。
